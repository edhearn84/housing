---
title: "Nominal House Prices in Luxembourg - Analyses"
author: "Eddie Hearn"
date: "`r Sys.Date()`"
---

```{r , warning = FALSE , message = FALSE}

library(dplyr)
library(ggplot2)
library(janitor)
library(purrr)
library(tidyr)

home_dir = "C:/Users/ehearn/OneDrive - Secretariat Advisors LLC/Desktop/Miscellaneous/housing/datasets"

```

Load datasets:

```{r}

commune_level_data = read.csv(paste0(home_dir , "/house_prices_commune_level_data.csv"))

country_level_data = 
  read.csv(paste0(home_dir , "/house_prices_country_level_data.csv"))

```

Create a function to compute a Laspeyeres price index at different levels of data aggregation.

```{r}

get_laspeyeres = function(dataset , start_year = "2010"){
  
  # "substitute()" replaces the variable "dataset" by its bound value and "deparse" converts the variable name into a string
  which_dataset = deparse(substitute(dataset))
  
  # Detection of "commune" in named string, grouping variable set to "locality" and NULL if not; use of "quo" delays evaluation of code until "!!group_var" code below
  group_var = if(grepl("commune" , which_dataset)){
    quo(locality)
  } else {
    NULL
  }
  
  dataset %>%
    group_by(!!group_var) %>%
    mutate(p0 = ifelse(year == start_year , 
                       average_price_nominal_euros , 
                       NA)) %>%
    fill(p0 , .direction = "down") %>%
    mutate(p0_m2 = ifelse(year == start_year , 
                          average_price_m2_nominal_euros , 
                          NA)) %>%
    fill(p0_m2 , .direction = "down") %>%
    ungroup() %>%
    mutate(
      p1 = average_price_nominal_euros/p0*100 , 
      p1_m2 = average_price_m2_nominal_euros/p0_m2*100)
}

```

Compute Laspeyeres for commune-level data.

```{r}

commune_level_data = get_laspeyeres(commune_level_data)

```

Also compute index for whole country.

```{r}

country_level_data = get_laspeyeres(country_level_data)

```

Create plots for 5 communes and compare the price evolution in the communes to the national price evolution. First, list the communes:

```{r}

communes = c("Luxembourg",
              "Esch-sur-Alzette",
              "Mamer",
              "Schengen",
              "Wincrange")

```


Write a function to create a plot of price indices.

```{r}

make_plot = function(commune){
  
  commune_data = commune_level_data %>%
    filter(locality == commune)
  
  data_to_plot = bind_rows(
    country_level_data , 
    commune_data
  )
  
  ggplot(data_to_plot) + 
    geom_line(aes(y = p1_m2 , 
                  x = year , 
                  group = locality , 
                  color = locality))
}

```

Create commune plots.

```{r , results = "asis"}

res = lapply(communes , function(x){
  print(make_plot(x))
}
)



```







